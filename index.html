<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Covoiturage U15</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; }
        .section { margin-bottom: 20px; }
        input, select, button { margin: 5px; padding: 5px; }
        ul { list-style-type: none; padding: 0; }
        li { margin-bottom: 5px; }
        .remove { color: red; cursor: pointer; margin-left: 10px; }
        .warning { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Covoiturage U15</h1>
    
    <div class="section">
        <label for="date">Date du covoiturage:</label>
        <input type="date" id="date">
    </div>

    <div class="section">
        <h2>Joueurs</h2>
        <input type="text" id="newPlayer" placeholder="Nom du joueur">
        <button onclick="addPlayer()">Ajouter joueur</button>
        <ul id="playerList"></ul>
    </div>

    <div class="section">
        <h2>Conducteurs</h2>
        <input type="text" id="newDriver" placeholder="Nom du conducteur">
        <input type="number" id="seats" placeholder="Nombre de places" min="1">
        <select id="direction">
            <option value="aller">Aller</option>
            <option value="retour">Retour</option>
            <option value="both">Aller et Retour</option>
        </select>
        <button onclick="addDriver()">Ajouter conducteur</button>
        <ul id="driverList"></ul>
    </div>

    <div class="section">
        <h2>Assignation des joueurs</h2>
        <select id="playerSelect"></select>
        <select id="driverSelect"></select>
        <select id="tripDirection">
            <option value="aller">Aller</option>
            <option value="retour">Retour</option>
        </select>
        <button onclick="assignPlayer()">Assigner</button>
    </div>

    <div class="section">
        <h2>Répartition des joueurs</h2>
        <div id="assignments"></div>
    </div>

    <script>
        // Configuration Firebase (à remplacer par vos propres informations)
        const firebaseConfig = {
              apiKey: "AIzaSyBfr0A4LZbuFc8D8MI0wL_nfzO3Atbcqwk",
  authDomain: "covoiturage-u15.firebaseapp.com",
  databaseURL: "https://covoiturage-u15-default-rtdb.firebaseio.com",
  projectId: "covoiturage-u15",
  storageBucket: "covoiturage-u15.appspot.com",
  messagingSenderId: "83669001760",
  appId: "1:83669001760:web:b0d65f3832344dd928be45"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let players = [];
        let drivers = [];
        let assignments = { aller: {}, retour: {} };

        function updateFirebase() {
            const data = {
                date: document.getElementById('date').value,
                players: players,
                drivers: drivers,
                assignments: assignments
            };
            database.ref('covoiturage').set(data);
        }

        function loadFromFirebase() {
            database.ref('covoiturage').once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('date').value = data.date || '';
                    players = data.players || [];
                    drivers = data.drivers || [];
                    assignments = data.assignments || { aller: {}, retour: {} };
                    updateLists();
                    updateAssignments();
                }
            });
        }

        function addPlayer() {
            const playerName = document.getElementById('newPlayer').value.trim();
            if (playerName && !players.includes(playerName)) {
                players.push(playerName);
                updateLists();
                updateFirebase();
            }
            document.getElementById('newPlayer').value = '';
        }

        function addDriver() {
            const driverName = document.getElementById('newDriver').value.trim();
            const seats = parseInt(document.getElementById('seats').value);
            const direction = document.getElementById('direction').value;
            if (driverName && seats && direction) {
                drivers.push({ name: driverName, seats: seats, direction: direction });
                updateLists();
                updateFirebase();
            }
            document.getElementById('newDriver').value = '';
            document.getElementById('seats').value = '';
        }

        function removePlayer(player) {
            players = players.filter(p => p !== player);
            ['aller', 'retour'].forEach(direction => {
                Object.keys(assignments[direction]).forEach(driver => {
                    assignments[direction][driver] = assignments[direction][driver].filter(p => p !== player);
                });
            });
            updateLists();
            updateAssignments();
            updateFirebase();
        }

        function removeDriver(driverName) {
            drivers = drivers.filter(d => d.name !== driverName);
            ['aller', 'retour'].forEach(direction => {
                delete assignments[direction][driverName];
            });
            updateLists();
            updateAssignments();
            updateFirebase();
        }

        function assignPlayer() {
            const player = document.getElementById('playerSelect').value;
            const driver = document.getElementById('driverSelect').value;
            const direction = document.getElementById('tripDirection').value;
            
            if (player && driver) {
                const driverObj = drivers.find(d => d.name === driver);
                if (!driverObj || (driverObj.direction !== 'both' && driverObj.direction !== direction)) {
                    alert("Ce conducteur n'est pas disponible pour cette direction.");
                    return;
                }

                // Vérifier si le joueur est déjà assigné à un autre conducteur pour cette direction
                Object.keys(assignments[direction]).forEach(d => {
                    assignments[direction][d] = assignments[direction][d].filter(p => p !== player);
                });

                if (!assignments[direction][driver]) {
                    assignments[direction][driver] = [];
                }

                // Vérifier si le conducteur a encore de la place
                if (assignments[direction][driver].length < driverObj.seats) {
                    assignments[direction][driver].push(player);
                    updateAssignments();
                    updateFirebase();
                } else {
                    alert("Ce conducteur n'a plus de place disponible pour cette direction.");
                }
            }
        }

        function updateLists() {
            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';
            players.forEach(player => {
                const li = document.createElement('li');
                li.textContent = player;
                const removeBtn = document.createElement('span');
                removeBtn.textContent = '❌';
                removeBtn.className = 'remove';
                removeBtn.onclick = () => removePlayer(player);
                li.appendChild(removeBtn);
                playerList.appendChild(li);
            });

            const driverList = document.getElementById('driverList');
            driverList.innerHTML = '';
            drivers.forEach(driver => {
                const li = document.createElement('li');
                li.textContent = `${driver.name} (${driver.seats} places, ${driver.direction})`;
                const removeBtn = document.createElement('span');
                removeBtn.textContent = '❌';
                removeBtn.className = 'remove';
                removeBtn.onclick = () => removeDriver(driver.name);
                li.appendChild(removeBtn);
                driverList.appendChild(li);
            });

            const playerSelect = document.getElementById('playerSelect');
            playerSelect.innerHTML = '';
            players.forEach(player => {
                const option = document.createElement('option');
                option.value = player;
                option.textContent = player;
                playerSelect.appendChild(option);
            });

            const driverSelect = document.getElementById('driverSelect');
            driverSelect.innerHTML = '';
            drivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver.name;
                option.textContent = driver.name;
                driverSelect.appendChild(option);
            });
        }

        function updateAssignments() {
            const assignmentsDiv = document.getElementById('assignments');
            assignmentsDiv.innerHTML = '';

            ['aller', 'retour'].forEach(direction => {
                const h3 = document.createElement('h3');
                h3.textContent = direction.charAt(0).toUpperCase() + direction.slice(1);
                assignmentsDiv.appendChild(h3);

                drivers.forEach(driver => {
                    if (driver.direction === 'both' || driver.direction === direction) {
                        const driverAssignments = assignments[direction][driver.name] || [];
                        const p = document.createElement('p');
                        p.textContent = `${driver.name} (${driverAssignments.length}/${driver.seats}): ${driverAssignments.join(', ')}`;
                        assignmentsDiv.appendChild(p);
                    }
                });
            });

            // Vérifier que tous les joueurs sont assignés pour l'aller et le retour
            const assignedPlayersAller = new Set(Object.values(assignments.aller).flat());
            const assignedPlayersRetour = new Set(Object.values(assignments.retour).flat());
            const unassignedPlayers = players.filter(player => 
                !assignedPlayersAller.has(player) || !assignedPlayersRetour.has(player));

            if (unassignedPlayers.length > 0) {
                const warning = document.createElement('p');
                warning.className = 'warning';
                warning.textContent = `Attention : ${unassignedPlayers.join(', ')} n'ont pas de covoiturage complet (aller et retour).`;
                assignmentsDiv.appendChild(warning);
            }
        }

        // Charger les données depuis Firebase au chargement de la page
        loadFromFirebase();

        // Mettre à jour Firebase lorsque la date change
        document.getElementById('date').addEventListener('change', updateFirebase);
    </script>
</body>
</html>
