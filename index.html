<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion du covoiturage - Basket</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1, h2, h3 { text-align: center; }
        form { margin-bottom: 20px; }
        input, button, select { margin: 5px 0; padding: 5px; }
        #dateDisplay { font-size: 1.2em; text-align: center; margin-bottom: 20px; }
        #covoiturageList, #joueursList, #debugInfo { border-top: 1px solid #ccc; padding-top: 20px; }
        .section { margin-bottom: 40px; }
        #debugInfo { background-color: #f0f0f0; padding: 10px; margin-top: 20px; }
        .joueur-select { display: inline-block; margin-right: 10px; }
        .delete-btn { background-color: #ff4d4d; color: white; border: none; padding: 5px 10px; cursor: pointer; }
        .trajet-options { margin-top: 10px; }
        .joueurs-trajet { margin-top: 10px; padding: 10px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>Gestion du covoiturage - Basket</h1>
    
    <div id="dateDisplay"></div>

    <div class="section">
        <h2>Ajouter un joueur</h2>
        <form id="joueurForm">
            <input type="text" id="nomJoueur" placeholder="Nom du joueur" required>
            <button type="submit">Ajouter un joueur</button>
        </form>
        <div id="joueursList"></div>
    </div>

    <div class="section">
        <h2>Ajouter un covoiturage</h2>
        <form id="covoiturageForm">
            <input type="text" id="nom" placeholder="Nom du conducteur" required>
            <input type="number" id="places" placeholder="Nombre de places disponibles" required min="1">
            <div class="trajet-options">
                <label><input type="checkbox" id="aller" name="trajet" value="aller" onchange="toggleJoueurSelection('aller')"> Aller</label>
                <label><input type="checkbox" id="retour" name="trajet" value="retour" onchange="toggleJoueurSelection('retour')"> Retour</label>
            </div>
            <div id="joueursSelectAller" class="joueurs-trajet" style="display: none;">
                <h3>Joueurs pour l'aller :</h3>
            </div>
            <div id="joueursSelectRetour" class="joueurs-trajet" style="display: none;">
                <h3>Joueurs pour le retour :</h3>
            </div>
            <button type="submit">Ajouter un covoiturage</button>
        </form>
        <div id="covoiturageList"></div>
    </div>

    <div id="debugInfo"></div>

    <script>
        // Configuration de Firebase (à remplacer par vos propres informations)
        const firebaseConfig = {
              apiKey: "AIzaSyBfr0A4LZbuFc8D8MI0wL_nfzO3Atbcqwk",
  authDomain: "covoiturage-u15.firebaseapp.com",
  databaseURL: "https://covoiturage-u15-default-rtdb.firebaseio.com",
  projectId: "covoiturage-u15",
  storageBucket: "covoiturage-u15.appspot.com",
  messagingSenderId: "83669001760",
  appId: "1:83669001760:web:b0d65f3832344dd928be45"
        };

        // Fonction pour afficher la date actuelle
        function updateDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dateDisplay').textContent = now.toLocaleDateString('fr-FR', options);
        }

        // Fonction de débogage
        function debugLog(message) {
            console.log(message);
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.innerHTML += `<p>${message}</p>`;
        }

        // Initialisation de Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            debugLog("Firebase initialisé avec succès");
        } catch (error) {
            debugLog(`Erreur lors de l'initialisation de Firebase: ${error.message}`);
        }

        const database = firebase.database();

        const covoiturageRef = database.ref('covoiturage');
        const joueursRef = database.ref('joueurs');

        function toggleJoueurSelection(trajet) {
            const isChecked = document.getElementById(trajet).checked;
            document.getElementById(`joueursSelect${trajet.charAt(0).toUpperCase() + trajet.slice(1)}`).style.display = isChecked ? 'block' : 'none';
        }

        // Fonction pour ajouter un covoiturage
        document.getElementById('covoiturageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const nom = document.getElementById('nom').value;
            const places = document.getElementById('places').value;
            const date = new Date().toISOString();
            const aller = document.getElementById('aller').checked;
            const retour = document.getElementById('retour').checked;
            const joueursAller = Array.from(document.querySelectorAll('#joueursSelectAller .joueur-select:checked')).map(el => el.value);
            const joueursRetour = Array.from(document.querySelectorAll('#joueursSelectRetour .joueur-select:checked')).map(el => el.value);

            if (!aller && !retour) {
                alert("Veuillez sélectionner au moins un trajet (aller et/ou retour)");
                return;
            }

            covoiturageRef.push({
                nom: nom,
                date: date,
                places: places,
                aller: aller,
                retour: retour,
                joueursAller: joueursAller,
                joueursRetour: joueursRetour
            }).then(() => {
                debugLog(`Covoiturage ajouté: ${nom}`);
                this.reset();
                document.getElementById('joueursSelectAller').style.display = 'none';
                document.getElementById('joueursSelectRetour').style.display = 'none';
                updateJoueurSelect();
            }).catch((error) => {
                debugLog(`Erreur lors de l'ajout du covoiturage: ${error.message}`);
            });
        });

        // Fonction pour ajouter un joueur
        document.getElementById('joueurForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const nom = document.getElementById('nomJoueur').value;

            joueursRef.push({
                nom: nom
            }).then(() => {
                debugLog(`Joueur ajouté: ${nom}`);
                this.reset();
                updateJoueurSelect();
            }).catch((error) => {
                debugLog(`Erreur lors de l'ajout du joueur: ${error.message}`);
            });
        });

        // Fonction pour supprimer un joueur
        function supprimerJoueur(joueurId) {
            joueursRef.child(joueurId).remove()
                .then(() => {
                    debugLog(`Joueur supprimé: ${joueurId}`);
                    updateJoueurSelect();
                })
                .catch((error) => {
                    debugLog(`Erreur lors de la suppression du joueur: ${error.message}`);
                });

            // Supprimer le joueur de tous les covoiturages
            covoiturageRef.once('value', function(snapshot) {
                snapshot.forEach(function(childSnapshot) {
                    const covoiturage = childSnapshot.val();
                    let updated = false;
                    if (covoiturage.joueursAller && covoiturage.joueursAller.includes(joueurId)) {
                        covoiturage.joueursAller = covoiturage.joueursAller.filter(id => id !== joueurId);
                        updated = true;
                    }
                    if (covoiturage.joueursRetour && covoiturage.joueursRetour.includes(joueurId)) {
                        covoiturage.joueursRetour = covoiturage.joueursRetour.filter(id => id !== joueurId);
                        updated = true;
                    }
                    if (updated) {
                        covoiturageRef.child(childSnapshot.key).update(covoiturage);
                    }
                });
            });
        }

        // Fonction pour supprimer un covoiturage
        function supprimerCovoiturage(covoiturageId) {
            covoiturageRef.child(covoiturageId).remove()
                .then(() => {
                    debugLog(`Covoiturage supprimé: ${covoiturageId}`);
                })
                .catch((error) => {
                    debugLog(`Erreur lors de la suppression du covoiturage: ${error.message}`);
                });
        }

        // Fonction pour mettre à jour la sélection des joueurs
        function updateJoueurSelect() {
            const joueursSelectAller = document.getElementById('joueursSelectAller');
            const joueursSelectRetour = document.getElementById('joueursSelectRetour');
            joueursSelectAller.innerHTML = '<h3>Joueurs pour l\'aller :</h3>';
            joueursSelectRetour.innerHTML = '<h3>Joueurs pour le retour :</h3>';
            joueursRef.once('value', function(snapshot) {
                snapshot.forEach(function(childSnapshot) {
                    const joueur = childSnapshot.val();
                    const joueurId = childSnapshot.key;
                    ['Aller', 'Retour'].forEach(trajet => {
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `joueur-${trajet}-${joueurId}`;
                        checkbox.className = 'joueur-select';
                        checkbox.value = joueurId;
                        const label = document.createElement('label');
                        label.htmlFor = `joueur-${trajet}-${joueurId}`;
                        label.textContent = joueur.nom;
                        document.getElementById(`joueursSelect${trajet}`).appendChild(checkbox);
                        document.getElementById(`joueursSelect${trajet}`).appendChild(label);
                        document.getElementById(`joueursSelect${trajet}`).appendChild(document.createElement('br'));
                    });
                });
            });
        }

        // Fonction pour afficher les covoiturages
        covoiturageRef.on('value', function(snapshot) {
            const covoiturageList = document.getElementById('covoiturageList');
            covoiturageList.innerHTML = '<h3>Liste des covoiturages</h3>';
            snapshot.forEach(function(childSnapshot) {
                const covoiturage = childSnapshot.val();
                const covoiturageId = childSnapshot.key;
                const covoiturageItem = document.createElement('div');
                const date = new Date(covoiturage.date);
                
                let joueursAllerHtml = '<p>Joueurs aller : ';
                let joueursRetourHtml = '<p>Joueurs retour : ';
                
                Promise.all([
                    Promise.all((covoiturage.joueursAller || []).map(joueurId => 
                        joueursRef.child(joueurId).once('value').then(snapshot => snapshot.val()?.nom || 'Joueur supprimé')
                    )),
                    Promise.all((covoiturage.joueursRetour || []).map(joueurId => 
                        joueursRef.child(joueurId).once('value').then(snapshot => snapshot.val()?.nom || 'Joueur supprimé')
                    ))
                ]).then(([joueursAllerNoms, joueursRetourNoms]) => {
                    joueursAllerHtml += joueursAllerNoms.join(', ') || 'Aucun';
                    joueursRetourHtml += joueursRetourNoms.join(', ') || 'Aucun';
                    joueursAllerHtml += '</p>';
                    joueursRetourHtml += '</p>';
                    
                    const trajetHtml = `<p>Trajet : ${covoiturage.aller ? 'Aller' : ''}${covoiturage.aller && covoiturage.retour ? ' et ' : ''}${covoiturage.retour ? 'Retour' : ''}</p>`;
                    
                    covoiturageItem.innerHTML = `
                        <p><strong>${covoiturage.nom}</strong> - Date : ${date.toLocaleDateString('fr-FR')}</p>
                        <p>Places disponibles : ${covoiturage.places}</p>
                        ${trajetHtml}
                        ${covoiturage.aller ? joueursAllerHtml : ''}
                        ${covoiturage.retour ? joueursRetourHtml : ''}
                        <button class="delete-btn" onclick="supprimerCovoiturage('${covoiturageId}')">Supprimer ce covoiturage</button>
                        <hr>
                    `;
                    covoiturageList.appendChild(covoiturageItem);
                });
            });
            debugLog("Liste des covoiturages mise à jour");
        }, function(error) {
            debugLog(`Erreur lors de la récupération des covoiturages: ${error.message}`);
        });

        // Fonction pour afficher les joueurs
        joueursRef.on('value', function(snapshot) {
            const joueursList = document.getElementById('joueursList');
            joueursList.innerHTML = '<h3>Liste des joueurs</h3>';
            snapshot.forEach(function(childSnapshot) {
                const joueur = childSnapshot.val();
                const joueurId = childSnapshot.key;
                const joueurItem = document.createElement('div');
                joueurItem.innerHTML = `
                    <p>
                        <strong>${joueur.nom}</strong>
